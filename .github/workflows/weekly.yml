name: BIP Watcher Weekly

on:
  schedule:
    - cron: "0 6 * * 1"
    - cron: "0 6 * * 4"
  workflow_dispatch:
    inputs:
      full_reset:
        description: "FULL RESET cache-store (shards + master) i start od zera"
        required: true
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

concurrency:
  group: bip-watcher
  cancel-in-progress: false

permissions:
  contents: write
  issues: write

jobs:

  # ===================== KROK 0: Init cache-store =====================
  init_cache_store:
    name: Init cache-store branch (single)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create cache-store branch if missing
        shell: bash
        run: |
          set -e
          git fetch origin +refs/heads/cache-store:refs/remotes/origin/cache-store || true

          if git show-ref --verify --quiet refs/remotes/origin/cache-store; then
            echo "✅ cache-store exists"
            exit 0
          fi

          echo "ℹ️ Creating cache-store branch"
          git checkout --orphan cache-store
          rm -rf ./* ./.gitignore || true
          mkdir -p shards master
          echo "cache-store initialized" > README.md

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md shards master
          git commit -m "Initialize cache-store [skip ci]"
          git push origin cache-store

  # ===================== FULL RESET (jeśli wybrany) =====================
  reset_cache_store:
    name: FULL RESET cache-store (one-shot)
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [init_cache_store]
    if: github.event_name == 'workflow_dispatch' && inputs.full_reset == 'true'
    steps:
      - uses: actions/checkout@v4
        with:
          ref: cache-store
          fetch-depth: 0

      - name: Wipe shards + master
        shell: bash
        run: |
          set -e
          rm -rf shards master
          mkdir -p shards master
          echo "RESET @ $(date -u +%F_%T) UTC" > README.md

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "FULL RESET cache-store [skip ci]" || echo "No changes"
          git push

  # ===================== BUILD MATRIX =====================
  setup:
    name: Build dynamic shard matrix
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [init_cache_store, reset_cache_store]
    outputs:
      matrix: ${{ steps.build_matrix.outputs.matrix }}
      total: ${{ steps.build_matrix.outputs.total }}

    steps:
      - uses: actions/checkout@v4

      - id: build_matrix
        shell: bash
        run: |
          python3 - <<'PY'
          import csv, json, os
          from pathlib import Path

          csv_file = Path("data/bipy1.csv")
          if not csv_file.exists():
              csv_file = Path("bipy1.csv")

          rows = []
          if csv_file.exists():
              with open(csv_file, encoding="utf-8") as f:
                  reader = csv.DictReader(f)
                  for row in reader:
                      name = (row.get("name") or "").strip()
                      url  = (row.get("url") or "").strip()
                      if name and url:
                          rows.append((name, url))

          total = len(rows)
          matrix = json.dumps({"shard": list(range(total))})

          with open(os.environ["GITHUB_OUTPUT"], "a") as f:
              f.write(f"matrix={matrix}\n")
              f.write(f"total={total}\n")

          print(f"Gmin: {total}")
          PY

  # ===================== SCAN =====================
  scan:
    name: Scan shard ${{ matrix.shard }}
    runs-on: ubuntu-latest
    continue-on-error: true
    timeout-minutes: 355
    needs: [setup]

    strategy:
      fail-fast: false
      max-parallel: 10
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - uses: actions/checkout@v4
        with:
          ref: cache-store
          path: cache-store
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Build runtime cache.json
        shell: bash
        run: |
          mkdir -p data
          echo '{"schema":10,"urls_seen":{},"content_seen":{},"gmina_seeds":{},"page_fprints":{},"gmina_frontiers":{},"gmina_retry":{},"dead_urls":{}}' > data/cache.json

      - name: Run watcher
        timeout-minutes: 325
        env:
          PYTHONUNBUFFERED: "1"
          SHARD_TOTAL: ${{ needs.setup.outputs.total }}
          SHARD_INDEX: "${{ matrix.shard }}"
          RUN_DEADLINE_MIN: "315"
          CONCURRENT_GMINY: "1"
          CONCURRENT_REQUESTS: "30"
          LIMIT_PER_HOST: "4"
          RATE_MIN_DELAY: "0.3"
          CHECKPOINT_EVERY_SEC: "300"
          RESET_CACHE: ${{ inputs.full_reset }}
        run: |
          python bip_watcher.py

      - name: Commit shard
        if: always()
        shell: bash
        env:
          SHARD_INDEX: "${{ matrix.shard }}"
        run: |
          if [ ! -f "data/cache_shard_${SHARD_INDEX}.json" ]; then
            echo "No shard file"
            exit 0
          fi

          mkdir -p cache-store/shards
          gzip -9 -c data/cache_shard_${SHARD_INDEX}.json > cache-store/shards/cache_shard_${SHARD_INDEX}.json.gz

          cd cache-store
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add shards/cache_shard_${SHARD_INDEX}.json.gz
          git commit -m "Update shard ${SHARD_INDEX} [skip ci]" || echo "No changes"
          git pull --rebase
          git push

  # ===================== MERGE + EMAIL =====================
  merge:
    name: Merge caches + email
    runs-on: ubuntu-latest
    needs: [scan]
    if: always()

    steps:
      - uses: actions/checkout@v4
        with:
          ref: cache-store
          path: cache-store
          fetch-depth: 0

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Send results email
        shell: bash
        env:
          GMAIL_USER: "kamiljelonek227@gmail.com"
          GMAIL_APP_PASSWORD: "sldy dhtk redc vwrn"
        run: |
          echo "Email placeholder — merge logic kept minimal after reset mode."
